<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>{% block title %}Location de voitures de luxe{% endblock %}</title>
        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>⚫️</text><text y=%221.3em%22 x=%220.2em%22 font-size=%2276%22 fill=%22%23fff%22>sf</text></svg>">
        {% block stylesheets %}
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
            <link href="{{ asset('css/compare.css') }}" rel="stylesheet">
            <style>
                body {
                    padding-top: 4.5rem;
                    transition: background-color 0.3s ease, color 0.3s ease;
                }
                .card {
                    transition: transform 0.2s, background-color 0.3s ease, color 0.3s ease;
                }
                .card:hover { transform: translateY(-2px); }
                .navbar-brand { font-weight: bold; }

                /* Modern navbar styles */
                .navbar-custom {
                    background: linear-gradient(90deg, rgba(86,180,255,1) 0%, rgba(88,166,255,1) 50%, rgba(255,106,0,1) 100%);
                    color: #07203a;
                    box-shadow: 0 4px 18px rgba(2,6,23,0.08);
                    border-bottom-left-radius: 0.35rem;
                    border-bottom-right-radius: 0.35rem;
                }

                /* Ensure brand and links are visible in both modes */
                .navbar-custom .navbar-brand, .navbar-custom .navbar-brand .ms-2 { color: rgba(255,255,255,0.95); }
                .navbar-custom .nav-link { color: rgba(255,255,255,0.95); }

                .navbar-custom .nav-link {
                    color: rgba(255,255,255,0.95);
                    font-weight: 500;
                    transition: color 0.15s ease, transform 0.12s ease;
                }

                .navbar-custom .nav-link:hover {
                    color: #07203a;
                    transform: translateY(-2px);
                    text-shadow: 0 1px 0 rgba(255,255,255,0.06);
                }

                .navbar-custom .btn-primary {
                    background: rgba(2,6,23,0.06);
                    color: #fff;
                    border: 1px solid rgba(255,255,255,0.08);
                }

                .navbar-avatar {
                    width: 36px;
                    height: 36px;
                    border-radius: 50%;
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    background: rgba(255,255,255,0.9);
                    color: #07203a;
                    font-weight: 600;
                    box-shadow: 0 2px 8px rgba(2,6,23,0.12);
                    margin-right: 0.5rem;
                }

                .nav-admin-badge {
                    background: rgba(0,0,0,0.08);
                    color: #fff;
                    font-size: 0.75rem;
                    padding: 0.15rem 0.4rem;
                    border-radius: 0.25rem;
                    margin-left: 0.35rem;
                }

                .navbar-toggler-custom {
                    border: none;
                    background: rgba(255,255,255,0.12);
                    width: 44px;
                    height: 36px;
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 0.35rem;
                }

                /* Dropdown styling to match navbar and dark mode */
                .dropdown-menu {
                    min-width: 180px;
                    border-radius: 0.5rem;
                }

                .dropdown-menu .dropdown-item { color: #07203a; }
                .dropdown-menu .dropdown-item:hover { background: rgba(255,255,255,0.06); }

                /* Dark Theme overrides for navbar */
                .dark-theme .navbar-custom {
                    /* Colorful gradient adapted for dark backgrounds: deep blue -> indigo -> warm orange accent */
                    background: linear-gradient(90deg, #031426 0%, #0b2240 50%, #2b1220 80%, #ff6a00 100%) !important;
                    color: #e6eef6;
                    box-shadow: 0 6px 24px rgba(0,0,0,0.6);
                    border-bottom-left-radius: 0.25rem;
                    border-bottom-right-radius: 0.25rem;
                    overflow: hidden;
                }
                /* Links and brand remain light but we add subtle glow on hover using the orange accent */
                .dark-theme .navbar-custom .nav-link { color: rgba(230,238,246,0.95); }
                .dark-theme .navbar-custom .nav-link:hover { color: #ffddb8; text-shadow: 0 1px 10px rgba(255,140,30,0.12); }
                .dark-theme .navbar-custom .navbar-brand, .dark-theme .navbar-custom .navbar-brand .ms-2 { color: #fff8ee; }

                /* Avatar and toggler tuned for dark colorful navbar */
                .dark-theme .navbar-avatar { background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); color: #ffdca8; box-shadow: 0 2px 8px rgba(0,0,0,0.6); border: 1px solid rgba(255,160,40,0.06); }
                .dark-theme .navbar-toggler-custom { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.02); }

                /* Admin badge accent */
                .dark-theme .nav-admin-badge { background: rgba(255,106,0,0.12); color: #ffddb8; border: 1px solid rgba(255,106,0,0.16); }

                /* Dropdown in dark colorful theme */
                .dark-theme .dropdown-menu {
                    background: linear-gradient(180deg, #071224 0%, #081822 60%); /* subtle depth */
                    color: #e6eef6;
                    border: 1px solid rgba(255,255,255,0.03);
                    box-shadow: 0 8px 30px rgba(2,8,23,0.6);
                }
                .dark-theme .dropdown-item { color: #e6eef6; }
                .dark-theme .dropdown-item:hover { background-color: rgba(255,106,0,0.08); color: #fff; }
                .dark-theme .dropdown-divider { border-color: rgba(255,255,255,0.03); }

                /* Dark Theme Styles */
                .dark-theme {
                    background-color: #1a1a1a !important;
                    color: #e0e0e0 !important;
                }

                .dark-theme .navbar {
                    background-color: #0d1117 !important;
                    border-bottom: 1px solid #30363d;
                }

                .dark-theme .card {
                    background-color: #21262d !important;
                    border-color: #30363d !important;
                    color: #e0e0e0 !important;
                }

                .dark-theme .card-header {
                    background-color: #161b22 !important;
                    border-bottom-color: #30363d !important;
                }

                .dark-theme .card-footer {
                    background-color: #161b22 !important;
                    border-top-color: #30363d !important;
                }

                .dark-theme .bg-light {
                    background-color: #21262d !important;
                }

                .dark-theme .text-muted {
                    color: #8b949e !important;
                }

                .dark-theme .table {
                    color: #e0e0e0 !important;
                }

                .dark-theme .table-hover tbody tr:hover {
                    background-color: #21262d !important;
                }

                .dark-theme .form-control {
                    background-color: #21262d !important;
                    border-color: #30363d !important;
                    color: #e0e0e0 !important;
                }

                .dark-theme .form-control:focus {
                    background-color: #21262d !important;
                    border-color: #58a6ff !important;
                    color: #e0e0e0 !important;
                    box-shadow: 0 0 0 0.2rem rgba(88, 166, 255, 0.25) !important;
                }

                .dark-theme .form-select {
                    background-color: #21262d !important;
                    border-color: #30363d !important;
                    color: #e0e0e0 !important;
                }

                .dark-theme .alert-info {
                    background-color: #0d419d !important;
                    border-color: #1f6feb !important;
                    color: #e0e0e0 !important;
                }

                .dark-theme .alert-success {
                    background-color: #0d4429 !important;
                    border-color: #238636 !important;
                    color: #e0e0e0 !important;
                }

                .dark-theme .alert-warning {
                    background-color: #5d4e00 !important;
                    border-color: #9a6700 !important;
                    color: #e0e0e0 !important;
                }

                .dark-theme .alert-danger {
                    background-color: #5d1a1a !important;
                    border-color: #da3633 !important;
                    color: #e0e0e0 !important;
                }

                .dark-theme .btn-outline-secondary {
                    color: #e0e0e0 !important;
                    border-color: #30363d !important;
                }

                .dark-theme .btn-outline-secondary:hover {
                    background-color: #30363d !important;
                    border-color: #30363d !important;
                    color: #e0e0e0 !important;
                }

                .dark-theme .btn-outline-primary {
                    color: #58a6ff !important;
                    border-color: #58a6ff !important;
                }

                .dark-theme .btn-outline-primary:hover {
                    background-color: #58a6ff !important;
                    border-color: #58a6ff !important;
                    color: #0d1117 !important;
                }

                .dark-theme .btn-outline-light {
                    color: #e0e0e0 !important;
                    border-color: #30363d !important;
                }

                .dark-theme .btn-outline-light:hover {
                    background-color: #30363d !important;
                    border-color: #30363d !important;
                    color: #e0e0e0 !important;
                }

                .dark-theme .navbar-text {
                    color: #e0e0e0 !important;
                }

                .dark-theme .navbar-nav .nav-link {
                    color: #e0e0e0 !important;
                }

                .dark-theme .navbar-nav .nav-link:hover {
                    color: #58a6ff !important;
                }

                .dark-theme .badge {
                    color: #e0e0e0 !important;
                }

                .dark-theme .modal-content {
                    background-color: #21262d !important;
                    color: #e0e0e0 !important;
                }

                .dark-theme .modal-header {
                    border-bottom-color: #30363d !important;
                }

                .dark-theme .modal-footer {
                    border-top-color: #30363d !important;
                }

                .dark-theme .btn-close {
                    filter: invert(1) grayscale(100%) brightness(200%);
                }

                /* 3D Animation Styles */
                .car-3d-btn {
                    perspective: 1000px;
                }

                .car-3d-btn img {
                    width: 50px;
                    height: 50px;
                    transition: transform 0.6s ease;
                }

                .car-3d-btn:hover img {
                    transform: rotateY(360deg);
                }

                /* Chat bubble styles */
                .chat-bubble {
                    position: fixed;
                    right: 90px; /* leave space for floating icon */
                    bottom: 24px;
                    width: 340px;
                    max-width: calc(100% - 120px);
                    background: linear-gradient(180deg, #ffffff, #fbfbfb);
                    border-radius: 14px;
                    box-shadow: 0 12px 40px rgba(2,6,23,0.18);
                    transform: scale(0.85);
                    transform-origin: bottom right;
                    opacity: 0;
                    visibility: hidden;
                    transition: transform 220ms cubic-bezier(.2,.9,.2,1), opacity 180ms ease, visibility 0ms linear 220ms;
                    /* élevé pour passer devant la barre 'Comparer' (z-index:9999) */
                    z-index: 11001;
                }
                .chat-bubble.dark-theme {
                    background: linear-gradient(180deg, #0c1220, #0e1624);
                    color: #e6eef6;
                    box-shadow: 0 18px 60px rgba(0,0,0,0.6);
                }
                .chat-bubble.chat-visible {
                    transform: scale(1);
                    opacity: 1;
                    visibility: visible;
                    transition-delay: 0ms;
                }
                .chat-header { border-bottom: 1px solid rgba(0,0,0,0.06); }
                .chat-bubble.dark-theme .chat-header { border-bottom-color: rgba(255,255,255,0.04); }
                .chat-body { background: transparent; }
                .chat-messages .message-bot { background: #f3f6fb; color: #07203a; padding: .5rem .75rem; border-radius: .5rem; display: inline-block; }
                .chat-bubble.dark-theme .chat-messages .message-bot { background: rgba(255,255,255,0.04); color: #e6eef6; }
                .chat-messages .message-user { background: #0d6efd; color: #fff; padding: .5rem .75rem; border-radius: .5rem; display: inline-block; }
                .chat-close { background: transparent; border: none; }

                /* Quick replies (suggestion buttons) */
                .chat-quick-replies {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 0.4rem;
                    margin-top: 0.6rem;
                    padding: 0 0.15rem 0.4rem 0.15rem;
                }
                .chat-quick-btn {
                    background: linear-gradient(90deg, #ffb020, #ff6a00);
                    color: #07203a;
                    border: none;
                    padding: 0.35rem 0.7rem;
                    border-radius: 999px;
                    font-size: 0.85rem;
                    cursor: pointer;
                    box-shadow: 0 6px 14px rgba(255,106,0,0.12);
                    transition: transform 120ms ease, box-shadow 120ms ease, opacity 120ms ease;
                }
                .chat-quick-btn:hover { transform: translateY(-3px); }
                .chat-quick-btn:active { transform: translateY(-1px) scale(0.995); }

                .chat-bubble.dark-theme .chat-quick-btn {
                    background: linear-gradient(90deg, #4b6bff, #6f49ff);
                    color: #fff;
                    box-shadow: 0 8px 20px rgba(16,24,40,0.36);
                }

                /* Steps list styling */
                .bot-steps-list { padding-left: 1rem; margin: 0.35rem 0 0 0; }
                .bot-steps-list li { margin: 0.25rem 0; font-size: 0.95rem; }

                /* typing indicator style */
                .chat-typing { opacity: 0.7; font-style: italic; }

                .chat-messages { padding-bottom: 0.25rem; }

                /* small responsive tweak */
                @media (max-width: 480px) {
                    .chat-bubble { right: 16px; left: 16px; width: auto; max-width: calc(100% - 32px); }
                    .chat-quick-btn { font-size: 0.82rem; padding: 0.3rem 0.6rem; }
                }
            </style>
        {% endblock %}

        {% block javascripts %}
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
            <script>
                // Dark/Light Mode Toggle
                document.addEventListener('DOMContentLoaded', function() {
                    const themeToggle = document.getElementById('themeToggle');
                    const themeIcon = document.getElementById('themeIcon');
                    const body = document.body;

                    // Check for saved theme preference or default to light mode
                    const currentTheme = localStorage.getItem('theme') || 'light';
                    setTheme(currentTheme);

                    themeToggle.addEventListener('click', function() {
                        const currentTheme = body.getAttribute('data-theme');
                        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                        setTheme(newTheme);
                        localStorage.setItem('theme', newTheme);
                    });

                    function setTheme(theme) {
                        body.setAttribute('data-theme', theme);
                        if (theme === 'dark') {
                            themeIcon.className = 'fas fa-sun';
                            body.classList.add('dark-theme');
                        } else {
                            themeIcon.className = 'fas fa-moon';
                            body.classList.remove('dark-theme');
                        }
                    }
                });
            </script>
            <script src="{{ asset('js/compare.js') }}"></script>
            <script src="{{ asset('js/chatbot.js') }}"></script>
        {% endblock %}
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-custom fixed-top">
             <div class="container">
                 <a class="navbar-brand d-flex align-items-center" href="{{ path('app_home') }}" title="Accueil" aria-label="Accueil">
                     <!-- Remplacement du viewer 3D par un SVG simple et léger -->
                     <span class="d-inline-block" aria-hidden="false" role="img">
                        <!-- inline SVG simple repris depuis public/images/icons/car-3d.svg pour meilleure résolution et contrôle -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 80" width="48" height="32" aria-hidden="true" role="img">
                          <defs>
                            <linearGradient id="g1" x1="0" x2="1">
                              <stop offset="0%" stop-color="#ffb020" />
                              <stop offset="100%" stop-color="#ff6a00" />
                            </linearGradient>
                            <linearGradient id="g2" x1="0" x2="1">
                              <stop offset="0%" stop-color="#ffffff" stop-opacity="0.9"/>
                              <stop offset="100%" stop-color="#ffffff" stop-opacity="0.2"/>
                            </linearGradient>
                          </defs>
                          <ellipse cx="60" cy="70" rx="36" ry="6" fill="rgba(0,0,0,0.25)" />
                          <g id="car" transform="translate(0,0)">
                            <rect x="10" y="28" rx="6" ry="6" width="100" height="28" fill="url(#g1)" />
                            <path d="M16 28 C24 16 40 16 60 16 C80 16 96 16 104 28" fill="none" stroke="url(#g1)" stroke-width="4" stroke-linecap="round"/>
                            <path d="M28 24 C36 20 48 20 62 24 C76 28 88 28 96 24" fill="url(#g2)" opacity="0.9"/>
                            <g fill="#111">
                              <circle cx="34" cy="62" r="8" fill="#111" />
                              <circle cx="86" cy="62" r="8" fill="#111" />
                              <circle cx="34" cy="62" r="4" fill="#bbb" />
                              <circle cx="86" cy="62" r="4" fill="#bbb" />
                            </g>
                          </g>
                          <path d="M22 30 C36 22 55 20 72 26" stroke="#ffffff" stroke-opacity="0.12" stroke-width="6" fill="none" stroke-linecap="round" />
                        </svg>
                     </span>
                     <span class="ms-2">RentCars</span>
                 </a>
                 <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample" aria-controls="navbarsExample" aria-expanded="false" aria-label="Basculer la navigation">
                    <span class="navbar-toggler-custom">
                        <i class="fas fa-bars" style="color:rgba(255,255,255,0.95);"></i>
                    </span>
                 </button>
                 <div class="collapse navbar-collapse" id="navbarsExample">
                     <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                         <li class="nav-item"><a class="nav-link" href="{{ path('app_catalogue') }}">Catalogue</a></li>
                         <li class="nav-item"><a class="nav-link" href="{{ path('app_reservations_mes') }}">Mes réservations</a></li>
                        {# Affiche le lien Admin seulement si l'utilisateur a ROLE_ADMIN #}
                        {% if is_granted('ROLE_ADMIN') %}
                            <li class="nav-item">
                                <a class="nav-link" href="{{ path('app_admin_dashboard') }}">Admin <span class="nav-admin-badge">ADM</span></a>
                            </li>
                        {% endif %}
                     </ul>
                     <div class="d-flex align-items-center">
                         <!-- Dark/Light Mode Toggle -->
                         <button class="btn btn-outline-light me-3" id="themeToggle" title="Basculer le thème">
                             <i class="fas fa-moon" id="themeIcon"></i>
                         </button>

                        {# Utilisateur connecté : avatar + dropdown. Sinon : boutons Connexion / Inscription #}
                        {% if app.user %}
                            <div class="d-flex align-items-center">
                                {# Avatar avec initiales #}
                                <div class="navbar-avatar" title="{{ app.user.userIdentifier }}">
                                    {{ (app.user.firstName ? app.user.firstName|slice(0,1) : app.user.userIdentifier|slice(0,1))|upper }}
                                </div>
                                <div class="dropdown">
                                    <a class="nav-link dropdown-toggle text-white" href="#" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">{{ app.user.firstName ? app.user.firstName : app.user.userIdentifier }}</a>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                                        <li><a class="dropdown-item" href="#">Profil</a></li>
                                        <li><a class="dropdown-item" href="{{ path('app_reservations_mes') }}">Mes réservations</a></li>
                                        {% if is_granted('ROLE_ADMIN') %}
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="{{ path('app_admin_dashboard') }}">Panneau Admin</a></li>
                                        {% endif %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="{{ path('app_logout') }}">Déconnexion</a></li>
                                    </ul>
                                </div>
                            </div>
                        {% else %}
                            <a class="btn btn-outline-light me-2" href="{{ path('app_login') }}">Connexion</a>
                            <a class="btn btn-light text-dark" href="{{ path('app_register') }}">Créer un compte</a>
                        {% endif %}
                     </div>
                 </div>
             </div>
         </nav>

         <main class="container">
             {% for label, messages in app.flashes %}
                 {% for message in messages %}
                     <div class="alert alert-{{ label }} alert-dismissible fade show" role="alert">
                         {{ message }}
                         <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
                     </div>
                 {% endfor %}
             {% endfor %}
             {% block body %}{% endblock %}
         </main>
         {# Floating chatbot button #}
         <button id="ai-chat-btn" class="ai-chat-btn car-3d-btn" title="Assistant" aria-label="Ouvrir l'assistant">
             <img src="{{ asset('images/icons/chatbot.svg') }}" alt="Assistant" />
         </button>

         {# Chatbot Offcanvas (remplacé par une bulle pop-up) #}
         <div id="aiChatBubble" class="chat-bubble" role="dialog" aria-labelledby="aiChatLabel" aria-hidden="true">
           <div class="chat-header d-flex align-items-center justify-content-between px-3 py-2">
             <div class="d-flex align-items-center gap-2">
               <strong id="aiChatLabel">Assistant</strong>
             </div>
             <button type="button" class="btn-close chat-close" aria-label="Fermer"></button>
           </div>
           <div class="chat-body p-3">
             <p class="small text-muted">Assistant prototype — intégration AI future. Commencez la conversation ci‑dessous.</p>
             <div class="chat-messages mb-3" style="min-height:160px; max-height:360px; overflow:auto;"></div>
             <form class="d-flex gap-2 chat-form">
               <input type="text" class="form-control" placeholder="Écris un message..." aria-label="Message" />
               <button class="btn btn-primary" type="submit">Envoyer</button>
             </form>
           </div>
         </div>

         <div id="compare-bar" style="position:fixed;right:20px;bottom:20px;z-index:9999;">
             <a href="{{ path('app_compare_index') }}" class="btn btn-warning">
                 <i class="fas fa-balance-scale me-1"></i>
                 Comparer (<span id="compare-count">{{ app.session.get('compare_vehicules') ? app.session.get('compare_vehicules')|length : 0 }}</span>)
             </a>
             <button id="compare-clear" class="btn btn-outline-light ms-2">Vider</button>
         </div>
     </body>
 </html>
